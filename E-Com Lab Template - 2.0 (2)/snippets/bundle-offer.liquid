{% liquid
  assign item_count = 0
  assign total_compare_price = 0
  assign total_price = 0
  assign total_percentage_left_multiplier = 100.0 | minus: block.settings.percentage_discount | divided_by: 100.0
  assign total_fixed_discount = block.settings.fixed_amount_discount | times: 100.0
  assign product_form_id = 'bundle-offer-' | append: section.id | append: block.id
  if block.settings.type == 'main'
    assign is_main = true
    assign is_separate = false
  else 
    assign is_separate = true
    assign is_main = false
  endif
  assign main_product_handle = product.handle
%}
<div 
  class='bundle-offer' 
  style='
    --image-size: {{ block.settings.images_size }}rem;
    --title-font-size: {{ block.settings.title_size }}rem;
    --desc-font-size: {{ block.settings.desc_size }}rem;
    --price-font-size: {{ block.settings.price_size }}rem;
    --border-color: var(--color-base-{{ block.settings.container_border_color }});
    --border-radius: {{ block.settings.border_radius | divided_by: 10.0 }}rem;
  ' 
  {{ block.shopify_attributes }}
>
  {% if block.settings.title_text != blank %}
    <h3 class='mt-0 {{ block.settings.heading_size }} {{ block.settings.title_alignment }}'>
      {{ block.settings.title_text }}
    </h3>
  {% endif %}
  <{% if is_separate %}bundle-deals{% else %}main-bundle-offer{% endif %} 
    class='bundle-offer-container custom-border custom-border-radius color-{{ block.settings.color_scheme }} accent-color-{{ block.settings.accent_color }}'
    style="padding: 10px; max-width: 100%; box-sizing: border-box;"
  >
    {% if block.settings.product_1 != blank %}
      {% liquid
        assign current_product = block.settings.product_1
        assign item_index = item_count
        assign item_count = item_count | plus: 1
        assign percentage_left_multiplier = 100.0 | minus: block.settings.product_1_percentage_discount | divided_by: 100.0
        assign fixed_discount = block.settings.product_1_fixed_amount_discount | times: 100.0
        assign price = current_product.first_available_variant.price | times: percentage_left_multiplier | minus: fixed_discount
        if current_product.first_available_variant.compare_at_price > current_product.first_available_variant.price
          assign compare_price = current_product.first_available_variant.compare_at_price
        else 
          assign compare_price = current_product.first_available_variant.price
        endif
        assign total_price = total_price | plus: price
        assign total_compare_price = total_compare_price | plus: compare_price
      %}
      <div class='upsell-container' style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #e0e0e0;">
        <div class='upsell-image' style="flex-shrink: 0; width: 60px; height: 60px; margin-right: 10px;">
          {% if block.settings.show_images and current_product.featured_image != blank %}
            <img
              src="{{ current_product.featured_image | image_url: width: 100 }}"
              alt="{{ current_product.featured_image.alt | escape }}"
              style="width: 100%; height: 100%; object-fit: cover; border-radius: 5px;"
            >
          {% endif %}
        </div>
        <div class='upsell-content' style="flex-grow: 1;">
          <h4 style="font-size: 1rem; margin: 0;">{{ current_product.title }}</h4>
          <div class='upsell-price' style="font-size: 0.875rem; color: #555;">
            {% if compare_price > price %}
              <span style="text-decoration: line-through; margin-right: 5px;">{{ compare_price | money }}</span>
            {% endif %}
            <span>{{ price | money }}</span>
          </div>
        </div>
      </div>
    {% endif %}
    
    <div class="bundle-offer-footer" style="display: flex; justify-content: space-between; padding: 10px 0; font-weight: bold;">
      <span>Total:</span>
      <span>{{ total_price | money }}</span>
    </div>
    
    <form action="/cart/add" method="post" style="display: flex; justify-content: center;">
      <input type="hidden" name="id" value="{{ current_product.first_available_variant.id }}">
      <button type="submit" class="grab-deal-button" style="width: 100%; padding: 12px; background-color: #000; color: #fff; border: none; font-size: 1rem; cursor: pointer;">
        {{ block.settings.button_label | default: 'Grab this Deal' }}
      </button>
    </form>
  </{% if is_separate %}bundle-deals{% else %}main-bundle-offer{% endif %}>
</div>

<style>
  @media only screen and (max-width: 768px) {
    .bundle-offer {
      width: 100%;
      padding: 5px;
    }
    .bundle-offer-container {
      flex-direction: column;
    }
    .upsell-container {
      flex-direction: row;
      align-items: center;
    }
    .grab-deal-button {
      font-size: 0.9rem;
    }
  }
</style>



  {% if is_separate %}
    <product-form class="product-form" data-section="{{ section.id }}-{{ block.id }}" data-include-pdp-upsells="{{ block.settings.include_pdp_upsells }}">
      <div class="product-form__error-message-wrapper" role="alert" hidden>
        <svg
          aria-hidden="true"
          focusable="false"
          class="icon icon-error"
          viewBox="0 0 13 13"
        >
          <circle cx="6.5" cy="6.50049" r="5.5" stroke="white" stroke-width="2"/>
          <circle cx="6.5" cy="6.5" r="5.5" fill="#EB001B" stroke="#EB001B" stroke-width="0.7"/>
          <path d="M5.87413 3.52832L5.97439 7.57216H7.02713L7.12739 3.52832H5.87413ZM6.50076 9.66091C6.88091 9.66091 7.18169 9.37267 7.18169 9.00504C7.18169 8.63742 6.88091 8.34917 6.50076 8.34917C6.12061 8.34917 5.81982 8.63742 5.81982 9.00504C5.81982 9.37267 6.12061 9.66091 6.50076 9.66091Z" fill="white"/>
          <path d="M5.87413 3.17832H5.51535L5.52424 3.537L5.6245 7.58083L5.63296 7.92216H5.97439H7.02713H7.36856L7.37702 7.58083L7.47728 3.537L7.48617 3.17832H7.12739H5.87413ZM6.50076 10.0109C7.06121 10.0109 7.5317 9.57872 7.5317 9.00504C7.5317 8.43137 7.06121 7.99918 6.50076 7.99918C5.94031 7.99918 5.46982 8.43137 5.46982 9.00504C5.46982 9.57872 5.94031 10.0109 6.50076 10.0109Z" fill="white" stroke="#EB001B" stroke-width="0.7">
        </svg>
        <span class="product-form__error-message"></span>
      </div>
      {%- form 'product',
        product,
        id: product_form_id,
        class: 'form',
        novalidate: 'novalidate',
        data-type: 'add-to-cart-form'
      -%}
        <div class="product-form__variants"></div>
        <input
          type="hidden"
          name="id"
          value=""
          disabled
          class="product-variant-id"
          {% if section.settings.skip_cart %}
            data-skip-cart="true"
          {% endif %}
        >
        <div class="product-form__buttons">
          <button
            type="submit"
            name="add"
            class="atc-button product-form__submit button button--full-width"
          >
            <span>
              {{ block.settings.button_label }}
            </span>
            <div class="loading-overlay__spinner hidden">
              <svg
                aria-hidden="true"
                focusable="false"
                class="spinner"
                viewBox="0 0 66 66"
                xmlns="http://www.w3.org/2000/svg"
              >
                <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
              </svg>
            </div>
          </button>
        </div>
      {%- endform -%}
    </product-form>
  {% endif %}
</div>
